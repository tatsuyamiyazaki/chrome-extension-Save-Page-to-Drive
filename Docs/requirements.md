# Chrome拡張「Save Page to Drive」要件定義書

## 1. 目的
- 現在アクティブなブラウザタブのWebページをPDF化し、ユーザーが指定したGoogleドライブのフォルダに保存できるようにする。
- ワンクリックでの保存体験を提供し、業務の記録・共有・アーカイブ効率を向上させる。

## 2. スコープ
- 対象: Google Chrome (Manifest V3) で動作する拡張機能。
- 対象外: 他ブラウザへの移植、Google以外のストレージ、PDFの編集機能。

## 3. 用語
- 本拡張: 本プロジェクトのChrome拡張機能。
- アクティブタブ: ユーザーが現在表示している最前面のタブ。
- Drive: Googleドライブ。

## 4. 対象ユーザー
- Webページを証跡として保存・共有したいビジネスユーザー、研究者、サポート担当、法務・監査担当など。

## 5. 成果物
- Chrome拡張パッケージ（`manifest.json`・サービスワーカー・UI・設定ページ等）。
- 要件・設計ドキュメント、利用手順、プライバシーポリシー、アイコン素材。

## 6. ユースケース / ユーザーストーリー
- 1クリックで現在のページをPDFにして、既定のDriveフォルダへ即保存したい。
- 保存先フォルダを事前に選択・変更したい（プロジェクトごとに使い分け）。
- 保存時にファイル名を自動命名したい（ページタイトル_日付時刻等）。
- 保存の進捗を確認し、完了/失敗を通知で知りたい。
- 初回だけGoogleアカウント連携（OAuth）を行い、以後は自動で保存したい。

## 7. 機能要件（Functional Requirements）
- 基本機能
  - [FR-1] アクティブタブのWebページをPDF生成する。
  - [FR-2] 生成したPDFを指定フォルダ（Drive上）へアップロードする。
  - [FR-3] 保存完了/失敗を通知（Chrome通知）で知らせる。

- 認証/権限
  - [FR-4] `chrome.identity` を用いたGoogle OAuth2でユーザー認可を取得する。
  - [FR-5] 必要最小限のスコープを利用（`https://www.googleapis.com/auth/drive.file`）。
  - [FR-6] アクセストークンは安全に管理し、利用最小化・期限管理を行う。

- PDF生成
  - [FR-7] CDP（Chrome DevTools Protocol）の `Page.printToPDF` を `chrome.debugger`経由で呼び出し、忠実なPDFを生成（推奨方式）。
  - [FR-8] 代替方式として `html2canvas + jsPDF` による描画型PDF生成を用意（必要に応じフォールバック）。
  - [FR-9] ページサイズ（A4など）、縦横、余白、ヘッダ/フッタ有無、背景グラフィックの有無を指定可能にする（最低限：A4/縦/余白標準/背景有無）。

- Googleドライブ保存
  - [FR-10] 既定の保存先フォルダIDを設定し、`chrome.storage.sync` に永続化。
  - [FR-11] 初期設定ウィザードまたはオプションページから保存先フォルダを選択/変更できる。
  - [FR-12] ファイル名命名規則（既定）：`<ページタイトル>_<YYYYMMDD-HHmmss>.pdf`。重複時は連番付与。
  - [FR-13] Drive API（`files.create` multipart/related）でバイナリアップロード。
  - [FR-14] 保存完了時にDriveのファイルリンクを通知/コピー可能にする（任意設定）。

- UI/操作
  - [FR-15] ブラウザアクション（ツールバーボタン）クリックで即保存。
  - [FR-16] コンテキストメニュー「このページをDriveへPDF保存」を提供。
  - [FR-17] ポップアップUI（最小）：直前の保存先表示・切替ショートカット・実行ボタン。
  - [FR-18] オプションページ：
    - 保存先フォルダ選択、命名規則、PDFオプション、通知設定、言語設定。

- 進捗/通知/リトライ
  - [FR-19] 実行中ステータスの視覚化（ポップアップ/通知）。
  - [FR-20] 失敗時の理由表示（認証・権限・ネットワーク・容量・レート制限等）。
  - [FR-21] 一時的エラー時の自動リトライ（指数バックオフ、最大回数設定）。

- 設定/同期
  - [FR-22] 設定値は `chrome.storage.sync`（同一アカウント間同期）を利用。
  - [FR-23] エクスポート/インポート（任意）で設定のバックアップを可能にする。

## 8. 非機能要件（Non-Functional Requirements）
- 対応環境
  - [NFR-1] Google Chrome 安定版 最新-2メジャーをサポート。
  - [NFR-2] Manifest V3 準拠（Service Workerベース）。

- セキュリティ/プライバシー
  - [NFR-3] 最小権限の原則（`debugger`, `identity`, `storage`, `scripting`, `contextMenus`, `notifications`）。
  - [NFR-4] 収集データ最小化。個人情報・閲覧履歴の過剰取得禁止。ポリシーを明示。
  - [NFR-5] OAuthトークンの安全管理（メモリ/ストレージ保護、不要時破棄）。

- パフォーマンス/信頼性
  - [NFR-6] PDF生成〜アップロードが通常ページで数秒〜十数秒以内を目安。
  - [NFR-7] 大規模ページでも異常終了しない（タイムアウト/分割処理/フォールバック）。

- 可観測性/保守性
  - [NFR-8] ユーザー向けの簡易ログ/エラーコード表示。
  - [NFR-9] デバッグログはユーザー同意時のみ収集/出力。

- 国際化
  - [NFR-10] i18n対応（初期: 日本語/英語）。

## 9. 制約・前提
- [C-1] Chrome拡張の仕様上、印刷ダイアログをスキップするため `chrome.debugger` + `Page.printToPDF` の利用を前提（ユーザーの明示操作に紐付け、権限ガイダンスを提供）。
- [C-2] Drive API利用のためGoogle Cloud ConsoleでOAuthクライアントID設定と審査対応が必要。
- [C-3] 組織ポリシーで`debugger`が禁止される場合、代替の描画方式に自動フォールバック。
- [C-4] 動的にロードされるコンテンツ、ログインが必要なページ、動画/キャンバスはPDF化の限界がある。

## 10. 実装方針（ハイレベル設計）
- アーキテクチャ
  - Service Worker（背景処理/権限管理/Drive通信）
  - ポップアップUI（ワンクリック保存/直近設定）
  - オプションページ（詳細設定/フォルダ選択/テスト）
  - コンテキストメニュー（代替トリガ）

- PDF生成フロー（推奨）
  1. ユーザー操作（ボタン/メニュー）をトリガ。
  2. `chrome.debugger.attach`（対象タブ）→ `Page.printToPDF` 呼び出し。
  3. base64 PDF取得、`chrome.debugger.detach`。

- Drive保存フロー
  1. `chrome.identity.getAuthToken` でアクセストークン取得。
  2. `files.create`（multipart/related）でアップロード（`parents: [<folderId>]`）。
  3. 成功時：通知・リンク提示、失敗時：エラー/リトライ。

- フォルダ選択UI
  - 初期はフォルダID直入力/貼付 + Driveツリー簡易ブラウズ。
  - 将来拡張でGoogle Picker API統合（キー/審査準備が整い次第）。

- 設定項目（例）
  - 保存先フォルダID、ファイル名規則、PDFオプション（サイズ/余白/背景）
  - 通知オン/オフ、完了時リンクコピー、言語

## 11. エラーハンドリング（例）
- 認証失敗/同意未取得 → 再同意ダイアログ/ガイダンス。
- Drive容量不足/権限不足 → 明確なメッセージと別フォルダ提案。
- レート制限/ネットワーク不安定 → バックオフ付きリトライ、オフラインキュー（任意）。
- PDF生成失敗（CDP） → フォールバック描画方式へ切替、もしくは再試行。

## 12. ログ/診断
- ユーザー操作/主要イベント/エラーコードを簡易記録（ユーザーが明示的に有効化）。
- 問題報告用に設定・環境情報の匿名化エクスポート（任意）。

## 13. UI概要（簡易）
- ポップアップ：保存ボタン／直近の保存先表示／クイック切替。
- オプション：フォルダ選択、PDFオプション、命名規則、通知、言語、動作テスト。
- 通知：進行中（アイコン+スピナー）→ 成功（リンク）／失敗（理由）。

## 14. 開発/テスト
- 最小実装（MVP）
  - ツールバーボタン→PDF生成（CDP）→既定フォルダにアップロード→通知。
  - オプションページでフォルダID設定、命名規則の一部設定。

- テスト観点
  - 権限付与・初回OAuth動線、PDF生成精度、各種ページ種別（長頁・SPA・メディア）。
  - エラー系（認可、容量、レート制限、ネットワーク、CDP失敗）。
  - 国際化/設定同期/更新後の後方互換。

## 15. リリース/配布
- Chromeウェブストア公開のためのポリシー遵守（権限の用途明示、プライバシーポリシー公開）。
- アイコン・説明文・スクリーンショット準備、審査対応。

## 16. リスクと対応
- `debugger` 権限の抵抗感 → 透明性の高い説明/局所利用/フォールバック用意。
- Drive APIの審査・クォータ → 早期申請・利用ログ最小化・指数バックオフ。
- 複雑ページのレンダ差異 → CDP優先/オプション調整/既知制約の明示。

## 17. 受け入れ基準（MVP）
- ツールバーボタン1回の操作で、アクティブタブのページがPDF化され、設定済みDriveフォルダに保存される。
- 成功/失敗の通知が表示され、成功時はDrive上でPDFを確認できるリンクが取得できる。
- 初回の設定（フォルダ選択、権限付与）が行えるオプションページが提供される。

## 18. 今後の拡張候補
- バッチ保存（タブ群/ウィンドウ全体）
- 自動ルール（URLパターン→保存先/命名）
- メタデータ付与（Driveカスタムプロパティ）
- バージョン管理/上書き設定
- 組織向けポリシーテンプレート

